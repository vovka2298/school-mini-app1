<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>–ö–∞–±–∏–Ω–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üëî</text></svg>">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      margin: 0;
      background: #0d1117;
      color: #c9d1d9;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    .header {
      background: #161b22;
      padding: 16px;
      border-bottom: 1px solid #30363d;
    }
    
    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    
    .avatar {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      border: 3px solid #f85149;
      background: #21262d;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    
    .refresh-btn {
      background: #238636;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }
    
    .refresh-btn:hover {
      background: #2ea043;
    }
    
    .content {
      padding: 16px;
      min-height: calc(100vh - 100px);
    }
    
    .teacher-card {
      background: #161b22;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid #30363d;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .teacher-card:hover {
      background: #21262d;
      border-color: #58a6ff;
      transform: translateY(-2px);
    }
    
    .teacher-name {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: white;
    }
    
    .teacher-stats {
      display: flex;
      gap: 16px;
      font-size: 14px;
      color: #8b949e;
    }
    
    .back-btn {
      background: #21262d;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      margin-bottom: 16px;
      cursor: pointer;
      font-size: 14px;
      width: 100%;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s;
    }
    
    .back-btn:hover {
      background: #30363d;
    }
    
    .tabs {
      display: flex;
      background: #161b22;
      border-bottom: 1px solid #30363d;
      margin-bottom: 16px;
    }
    
    .tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      user-select: none;
    }
    
    .tab.active {
      background: #1f6feb;
      color: white;
    }
    
    .section {
      background: #161b22;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid #30363d;
    }
    
    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      color: white;
    }
    
    .add-student-btn {
      background: #238636;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 12px;
      width: 100%;
      transition: background 0.2s;
    }
    
    .add-student-btn:hover {
      background: #2ea043;
    }
    
    .student-item {
      background: #21262d;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .student-name {
      font-weight: 500;
    }
    
    .student-class {
      font-size: 12px;
      color: #8b949e;
      margin-top: 4px;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: #161b22;
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      width: 100%;
      border: 1px solid #30363d;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 16px;
      color: white;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: #c9d1d9;
    }
    
    .form-input {
      width: 100%;
      padding: 12px;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      box-sizing: border-box;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #58a6ff;
    }
    
    .form-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    
    .btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: #1f6feb;
      color: white;
    }
    
    .btn-primary:hover {
      background: #1565c0;
    }
    
    .btn-secondary {
      background: #21262d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #30363d;
    }
    
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #8b949e;
      font-size: 16px;
    }
    
    .error {
      text-align: center;
      padding: 60px 20px;
      color: #da3633;
    }
    
    .statistics-section {
      background: #161b22;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid #30363d;
    }
    
    .date-filter {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    
    .date-input {
      flex: 1;
      min-width: 140px;
      padding: 10px;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 8px;
      color: white;
      font-size: 14px;
    }
    
    .stat-summary {
      background: #21262d;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .stat-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .stat-label {
      color: #8b949e;
    }
    
    .stat-value {
      font-weight: 600;
      color: white;
    }
    
    .student-stat {
      background: #21262d;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
    }
    
    .student-stat-header {
      font-weight: 600;
      margin-bottom: 8px;
      color: white;
    }
    
    .notice {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #1f6feb;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      animation: slideIn 0.3s;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    @keyframes slideIn {
      from { transform: translateX(100px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .schedule-view {
      overflow-x: auto;
    }
    
    .schedule-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    
    .schedule-table td {
      padding: 4px;
      text-align: center;
      border: 1px solid #30363d;
    }
    
    .schedule-slot {
      width: 40px;
      height: 30px;
      border-radius: 4px;
    }
    
    .slot-0 { background: #21262d; }
    .slot-1 { background: #238636; }
    .slot-2 { background: #da3633; }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-top">
      <div class="user-info">
        <div class="avatar">üëî</div>
        <div>
          <h3 id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</h3>
          <p>–ö–∞–±–∏–Ω–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞</p>
        </div>
      </div>
      <button class="refresh-btn" id="refreshBtn" onclick="loadTeachers()">
        üîÑ –û–±–Ω–æ–≤–∏—Ç—å
      </button>
    </div>
  </div>
  
  <div class="content" id="content">
    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π...</div>
  </div>
  
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–µ–Ω–∏–∫–∞ -->
  <div class="modal" id="addStudentModal">
    <div class="modal-content">
      <div class="modal-title">–î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞</div>
      <form id="addStudentForm" onsubmit="addStudent(event)">
        <div class="form-group">
          <label class="form-label">–ò–º—è *</label>
          <input type="text" class="form-input" id="studentFirstName" required>
        </div>
        <div class="form-group">
          <label class="form-label">–§–∞–º–∏–ª–∏—è</label>
          <input type="text" class="form-input" id="studentLastName">
        </div>
        <div class="form-group">
          <label class="form-label">–ö–ª–∞—Å—Å</label>
          <input type="text" class="form-input" id="studentClass" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 10–ê">
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeAddStudentModal()">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É—á–µ–Ω–∏–∫–∞ -->
  <div class="modal" id="editStudentModal">
    <div class="modal-content">
      <div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —É—á–µ–Ω–∏–∫–∞</div>
      <form id="editStudentForm" onsubmit="updateStudent(event)">
        <input type="hidden" id="editStudentId">
        <div class="form-group">
          <label class="form-label">–ò–º—è *</label>
          <input type="text" class="form-input" id="editStudentFirstName" required>
        </div>
        <div class="form-group">
          <label class="form-label">–§–∞–º–∏–ª–∏—è</label>
          <input type="text" class="form-input" id="editStudentLastName">
        </div>
        <div class="form-group">
          <label class="form-label">–ö–ª–∞—Å—Å</label>
          <input type="text" class="form-input" id="editStudentClass" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 10–ê">
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeEditStudentModal()">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Telegram Web App
    if (typeof Telegram !== 'undefined') {
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
    }
    
    // –î–∞–Ω–Ω—ã–µ
    let currentView = 'teachers'; // 'teachers' –∏–ª–∏ 'teacher-detail'
    let currentTeacherId = null;
    let teachers = [];
    let currentTeacherData = null;
    
    // –ü–æ–ª—É—á–∏—Ç—å telegram_id –∏–∑ Telegram Web App
    function getTelegramId() {
      if (typeof Telegram !== 'undefined' && Telegram.WebApp && Telegram.WebApp.initDataUnsafe) {
        const user = Telegram.WebApp.initDataUnsafe.user;
        if (user && user.id) {
          return user.id.toString();
        }
      }
      // Fallback –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
      return '913096324';
    }
    
    const MY_TG_ID = getTelegramId();
    
    // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    function showNotice(message, type = 'success') {
      const colors = {
        success: '#238636',
        error: '#da3633',
        info: '#1f6feb'
      };
      
      const notice = document.createElement('div');
      notice.className = 'notice';
      notice.style.background = colors[type] || colors.info;
      notice.textContent = message;
      document.body.appendChild(notice);
      
      setTimeout(() => {
        notice.style.opacity = '0';
        notice.style.transform = 'translateX(100px)';
        setTimeout(() => document.body.removeChild(notice), 300);
      }, 2000);
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function loadUser() {
      try {
        const response = await fetch(`/api/user?tgId=${MY_TG_ID}&t=${Date.now()}`);
        const user = await response.json();
        document.getElementById('userName').textContent = user.name || "–ú–µ–Ω–µ–¥–∂–µ—Ä";
      } catch (error) {
        document.getElementById('userName').textContent = "–ú–µ–Ω–µ–¥–∂–µ—Ä";
      }
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π
    async function loadTeachers() {
      try {
        document.getElementById('content').innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π...</div>';
        
        const response = await fetch(`/api/manager/teachers?tgId=${MY_TG_ID}&t=${Date.now()}`);
        const data = await response.json();
        
        teachers = data.teachers || [];
        
        if (teachers.length === 0) {
          document.getElementById('content').innerHTML = `
            <div class="loading">
              –ù–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π
            </div>
          `;
          return;
        }
        
        renderTeachersList();
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π:', error);
        document.getElementById('content').innerHTML = `
          <div class="error">
            –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π
            <br>
            <button onclick="loadTeachers()" style="margin-top: 20px; padding: 10px 20px; background: #1f6feb; color: white; border: none; border-radius: 8px; cursor: pointer;">
              –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
            </button>
          </div>
        `;
      }
    }
    
    // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π
    function renderTeachersList() {
      let html = '';
      
      teachers.forEach(teacher => {
        html += `
          <div class="teacher-card" onclick="showTeacherDetail(${teacher.id})">
            <div class="teacher-name">
              ${teacher.first_name} ${teacher.last_name || ''}
            </div>
            <div class="teacher-stats">
              <span>üë• –£—á–µ–Ω–∏–∫–æ–≤: ${teacher.students_count || 0}</span>
              <span>‚è∞ –ó–∞–Ω—è—Ç–æ—Å—Ç—å: ${teacher.weekly_hours || '0 —á'}</span>
            </div>
          </div>
        `;
      });
      
      document.getElementById('content').innerHTML = html;
      currentView = 'teachers';
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
    async function showTeacherDetail(teacherId) {
      try {
        currentTeacherId = teacherId;
        currentView = 'teacher-detail';
        
        document.getElementById('content').innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...</div>';
        
        const response = await fetch(`/api/manager/teacher/${teacherId}?tgId=${MY_TG_ID}&t=${Date.now()}`);
        const data = await response.json();
        
        currentTeacherData = data;
        renderTeacherDetail(data);
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è:', error);
        showNotice('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏', 'error');
        loadTeachers();
      }
    }
    
    // –†–µ–Ω–¥–µ—Ä –¥–µ—Ç–∞–ª–µ–π –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
    function renderTeacherDetail(data) {
      const { teacher, schedule, subjects, students } = data;
      
      // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∑–∞–Ω—è—Ç—ã–µ —á–∞—Å—ã –∏–∑ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
      let occupiedSlots = 0;
      const FULL_DAYS = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];
      const TIMES = [];
      for (let h = 8; h <= 22; h++) {
        TIMES.push(`${h.toString().padStart(2, '0')}:00`);
        if (h < 22) TIMES.push(`${h.toString().padStart(2, '0')}:30`);
      }
      
      FULL_DAYS.forEach(day => {
        TIMES.forEach(time => {
          const slotValue = schedule[day]?.[time] || 0;
          const state = typeof slotValue === 'object' ? slotValue.status : slotValue;
          if (state === 2) {
            occupiedSlots++;
          }
        });
      });
      
      // –ö–∞–∂–¥—ã–π —Å–ª–æ—Ç = 30 –º–∏–Ω—É—Ç
      const totalMinutes = occupiedSlots * 30;
      const hours = Math.floor(totalMinutes / 60);
      const minutes = totalMinutes % 60;
      
      // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å —á–∞—Å–∞–º–∏
      let weeklyHoursText = '0 —á';
      if (hours > 0 && minutes > 0) {
        weeklyHoursText = `${hours} —á ${minutes} –º`;
      } else if (hours > 0) {
        weeklyHoursText = `${hours} —á`;
      } else if (minutes > 0) {
        weeklyHoursText = `${minutes} –º`;
      }
      
      let html = `
        <button class="back-btn" onclick="loadTeachers()">
          <span style="font-size: 18px;">‚Üê</span>
          –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π
        </button>
        
        <div class="tabs">
          <div class="tab active" onclick="showTeacherTab('info')">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
          <div class="tab" onclick="showTeacherTab('schedule')">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
          <div class="tab" onclick="showTeacherTab('statistics')">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
        </div>
        
        <div id="teacherTabContent">
      `;
      
      // –í–∫–ª–∞–¥–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
      html += `
        <div id="tab-info" class="tab-content">
          <div class="section">
            <div class="section-title">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</div>
            <div style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">
              ${teacher.first_name} ${teacher.last_name || ''}
            </div>
            <div style="display: flex; align-items: center; gap: 12px; margin-top: 12px; padding: 12px; background: #21262d; border-radius: 8px;">
              <span style="color: #58a6ff; font-weight: 600;">‚è∞ –ó–∞–Ω—è—Ç–æ—Å—Ç—å –∑–∞ –Ω–µ–¥–µ–ª—é:</span>
              <span style="color: white; font-weight: 600; font-size: 16px;">${weeklyHoursText}</span>
            </div>
          </div>
          
          <div class="section">
            <div class="section-title">–ü—Ä–µ–¥–º–µ—Ç—ã</div>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
              ${subjects.length > 0 ? subjects.map(s => `
                <span style="background: #21262d; padding: 6px 12px; border-radius: 6px; font-size: 14px;">
                  ${s}
                </span>
              `).join('') : '<span style="color: #8b949e;">–ü—Ä–µ–¥–º–µ—Ç—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã</span>'}
            </div>
          </div>
          
          <div class="section">
            <div class="section-title">–£—á–µ–Ω–∏–∫–∏ (${students.length})</div>
            ${students.length > 0 ? students.map(s => `
              <div class="student-item">
                <div style="flex: 1;">
                  <div class="student-name">${s.first_name} ${s.last_name || ''}</div>
                  ${s.class_name ? `<div class="student-class">–ö–ª–∞—Å—Å: ${s.class_name}</div>` : ''}
                </div>
                <div style="display: flex; gap: 8px;">
                  <button onclick="openEditStudentModal(${s.id}, '${s.first_name}', '${s.last_name || ''}', '${s.class_name || ''}')" style="
                    background: #1f6feb;
                    color: white;
                    border: none;
                    padding: 6px 12px;
                    border-radius: 6px;
                    font-size: 12px;
                    cursor: pointer;
                    white-space: nowrap;
                  ">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                  <button onclick="deleteStudent(${s.id})" style="
                    background: #da3633;
                    color: white;
                    border: none;
                    padding: 6px 12px;
                    border-radius: 6px;
                    font-size: 12px;
                    cursor: pointer;
                    white-space: nowrap;
                  ">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                </div>
              </div>
            `).join('') : '<div style="color: #8b949e; text-align: center; padding: 20px;">–ù–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤</div>'}
            <button class="add-student-btn" onclick="openAddStudentModal()">
              + –î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞
            </button>
          </div>
        </div>
      `;
      
      // –í–∫–ª–∞–¥–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
      html += `
        <div id="tab-schedule" class="tab-content" style="display: none;">
          <div class="section">
            <div class="section-title">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
            <div class="schedule-view">
              ${renderScheduleView(schedule)}
            </div>
          </div>
        </div>
      `;
      
      // –í–∫–ª–∞–¥–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
      html += `
        <div id="tab-statistics" class="tab-content" style="display: none;">
          <div class="statistics-section">
            <div class="section-title">–ü–µ—Ä–∏–æ–¥ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞</div>
            <div class="date-filter">
              <input type="date" class="date-input" id="startDate" onchange="loadStatistics()">
              <input type="date" class="date-input" id="endDate" onchange="loadStatistics()">
            </div>
            <div id="statisticsContent">
              <div class="loading">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</div>
            </div>
          </div>
        </div>
      `;
      
      html += `</div>`;
      
      document.getElementById('content').innerHTML = html;
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: —Å –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏ –ø–æ —Å–µ–≥–æ–¥–Ω—è
      const today = new Date();
      const monday = new Date(today);
      // –ü–æ–ª—É—á–∞–µ–º –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ (0 = –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ, 1 = –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, ..., 6 = —Å—É–±–±–æ—Ç–∞)
      const dayOfWeek = today.getDay();
      // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–æ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞
      const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
      monday.setDate(today.getDate() - daysToMonday);
      document.getElementById('startDate').value = monday.toISOString().split('T')[0];
      document.getElementById('endDate').value = today.toISOString().split('T')[0];
    }
    
    // –†–µ–Ω–¥–µ—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    function renderScheduleView(schedule) {
      const DAYS = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
      const FULL_DAYS = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];
      const TIMES = [];
      for (let h = 8; h <= 22; h++) {
        TIMES.push(`${h.toString().padStart(2, '0')}:00`);
        if (h < 22) TIMES.push(`${h.toString().padStart(2, '0')}:30`);
      }
      
      let html = '<table class="schedule-table"><thead><tr><th>–í—Ä–µ–º—è</th>';
      DAYS.forEach(d => html += `<th>${d}</th>`);
      html += '</tr></thead><tbody>';
      
      TIMES.forEach(time => {
        html += `<tr><td style="font-size: 10px; padding: 4px;">${time}</td>`;
        DAYS.forEach((_, i) => {
          const day = FULL_DAYS[i];
          const state = schedule[day]?.[time] || 0;
          html += `<td><div class="schedule-slot slot-${state}" title="${time} ${day}"></div></td>`;
        });
        html += '</tr>';
      });
      
      html += '</tbody></table>';
      
      html += '<div style="margin-top: 16px; display: flex; gap: 16px; font-size: 12px;">';
      html += '<div><div class="schedule-slot slot-0" style="display: inline-block; margin-right: 8px;"></div>–ù–µ —Ä–∞–±–æ—Ç–∞—é</div>';
      html += '<div><div class="schedule-slot slot-1" style="display: inline-block; margin-right: 8px;"></div>–°–≤–æ–±–æ–¥–µ–Ω</div>';
      html += '<div><div class="schedule-slot slot-2" style="display: inline-block; margin-right: 8px;"></div>–ó–∞–Ω—è—Ç</div>';
      html += '</div>';
      
      return html;
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
    function showTeacherTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
      
      if (tabName === 'info') {
        document.querySelectorAll('.tab')[0].classList.add('active');
        document.getElementById('tab-info').style.display = 'block';
      } else if (tabName === 'schedule') {
        document.querySelectorAll('.tab')[1].classList.add('active');
        document.getElementById('tab-schedule').style.display = 'block';
      } else if (tabName === 'statistics') {
        document.querySelectorAll('.tab')[2].classList.add('active');
        document.getElementById('tab-statistics').style.display = 'block';
        loadStatistics();
      }
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    async function loadStatistics() {
      if (!currentTeacherId) return;
      
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      
      if (!startDate || !endDate) {
        return;
      }
      
      try {
        document.getElementById('statisticsContent').innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</div>';
        
        const response = await fetch(
          `/api/manager/teacher/${currentTeacherId}/statistics?tgId=${MY_TG_ID}&start_date=${startDate}&end_date=${endDate}&t=${Date.now()}`
        );
        const data = await response.json();
        
        let html = `
          <div class="stat-summary">
            <div class="stat-item">
              <span class="stat-label">–í—Å–µ–≥–æ —á–∞—Å–æ–≤:</span>
              <span class="stat-value">${data.total_hours || 0} —á</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">–í—Å–µ–≥–æ –∑–∞–Ω—è—Ç–∏–π:</span>
              <span class="stat-value">${data.total_lessons || 0}</span>
            </div>
          </div>
        `;
        
        if (data.by_student && data.by_student.length > 0) {
          html += '<div class="section-title" style="margin-top: 16px;">–ü–æ —É—á–µ–Ω–∏–∫–∞–º:</div>';
          data.by_student.forEach((stat, index) => {
            const studentName = `${stat.student.first_name || ''} ${stat.student.last_name || ''}`.trim();
            const studentId = `student-${index}`;
            const arrowId = `arrow-${index}`;
            html += `
              <div class="student-stat" style="cursor: pointer; transition: background 0.2s;" 
                   onclick="toggleStudentDetails('${studentId}', '${arrowId}')"
                   onmouseover="this.style.background='#1c2128'" 
                   onmouseout="this.style.background='#161b22'">
                <div class="student-stat-header" style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <strong>${studentName}</strong>
                    ${stat.student.class_name ? ` <span style="color: #8b949e;">(${stat.student.class_name})</span>` : ''}
                  </div>
                  <div id="${arrowId}" style="font-size: 12px; color: #8b949e; transition: transform 0.2s;">‚ñ∂</div>
                </div>
                <div style="font-size: 14px; color: #8b949e; margin-top: 4px;">
                  –ó–∞–Ω—è—Ç–∏–π: ${stat.lessons_count} | –ß–∞—Å–æ–≤: ${stat.total_hours} —á
                </div>
                <div id="${studentId}" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid #30363d;">
                  ${stat.lessons && stat.lessons.length > 0 ? `
                    <div style="font-size: 13px; color: #8b949e; margin-bottom: 8px; font-weight: 600;">–î–µ—Ç–∞–ª–∏ –∑–∞–Ω—è—Ç–∏–π:</div>
                    ${stat.lessons.map(lesson => {
                      const date = new Date(lesson.date).toLocaleDateString('ru-RU', { 
                        day: '2-digit', 
                        month: '2-digit', 
                        year: 'numeric',
                        weekday: 'short'
                      });
                      const durationHours = lesson.duration_minutes ? Math.floor(lesson.duration_minutes / 60) : 0;
                      const durationMinutes = lesson.duration_minutes ? lesson.duration_minutes % 60 : 0;
                      const durationText = durationHours > 0 ? `${durationHours}—á ${durationMinutes}–º` : `${durationMinutes}–º`;
                      return `
                        <div style="
                          background: #0d1117;
                          border-radius: 8px;
                          padding: 12px;
                          margin-bottom: 8px;
                          border-left: 3px solid #238636;
                        ">
                          <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                              <div style="font-size: 14px; margin-bottom: 6px; font-weight: 500;">
                                üìÖ ${date}
                              </div>
                              <div style="font-size: 13px; color: #8b949e; margin-bottom: 6px;">
                                ‚è∞ ${lesson.start_time} - ${lesson.end_time}
                                ${lesson.duration_minutes ? ` <span style="color: #58a6ff;">(${durationText})</span>` : ''}
                              </div>
                              ${lesson.subject ? `
                                <div style="font-size: 13px; color: #58a6ff; margin-top: 4px;">
                                  üìö ${lesson.subject}
                                </div>
                              ` : ''}
                              ${lesson.notes ? `
                                <div style="font-size: 12px; color: #8b949e; margin-top: 6px; padding-top: 6px; border-top: 1px solid #30363d;">
                                  ${lesson.notes}
                                </div>
                              ` : ''}
                            </div>
                            <div style="display: flex; gap: 6px; margin-left: 12px;">
                              <button onclick="openEditLessonModalManager(${lesson.id}, ${currentTeacherId})" style="
                                background: #1f6feb;
                                color: white;
                                border: none;
                                padding: 6px 10px;
                                border-radius: 6px;
                                font-size: 11px;
                                cursor: pointer;
                                white-space: nowrap;
                              ">‚úèÔ∏è</button>
                              <button onclick="deleteLessonManager(${lesson.id})" style="
                                background: #da3633;
                                color: white;
                                border: none;
                                padding: 6px 10px;
                                border-radius: 6px;
                                font-size: 11px;
                                cursor: pointer;
                                white-space: nowrap;
                              ">üóëÔ∏è</button>
                            </div>
                          </div>
                        </div>
                      `;
                    }).join('')}
                  ` : '<div style="color: #8b949e; font-size: 13px;">–ù–µ—Ç –¥–µ—Ç–∞–ª–µ–π –∑–∞–Ω—è—Ç–∏–π</div>'}
                </div>
              </div>
            `;
          });
        } else {
          html += '<div style="color: #8b949e; text-align: center; padding: 20px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</div>';
        }
        
        document.getElementById('statisticsContent').innerHTML = html;
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
        document.getElementById('statisticsContent').innerHTML = `
          <div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</div>
        `;
      }
    }
    
    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–µ–Ω–∏–∫–∞
    function openAddStudentModal() {
      document.getElementById('addStudentModal').classList.add('active');
      document.getElementById('studentFirstName').focus();
    }
    
    function closeAddStudentModal() {
      document.getElementById('addStudentModal').classList.remove('active');
      document.getElementById('addStudentForm').reset();
    }
    
    async function addStudent(event) {
      event.preventDefault();
      
      const firstName = document.getElementById('studentFirstName').value.trim();
      const lastName = document.getElementById('studentLastName').value.trim();
      const className = document.getElementById('studentClass').value.trim();
      
      try {
        const response = await fetch(
          `/api/manager/teacher/${currentTeacherId}/student?tgId=${MY_TG_ID}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              first_name: firstName,
              last_name: lastName,
              class_name: className || null
            })
          }
        );
        
        const result = await response.json();
        
        if (response.ok && result.ok) {
          showNotice('–£—á–µ–Ω–∏–∫ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
          closeAddStudentModal();
          // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
          showTeacherDetail(currentTeacherId);
        } else {
          showNotice(result.error || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–µ–Ω–∏–∫–∞', 'error');
        }
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–µ–Ω–∏–∫–∞:', error);
        showNotice('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–µ–Ω–∏–∫–∞', 'error');
      }
    }
    
    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–Ω—è—Ç–∏—è (–º–µ–Ω–µ–¥–∂–µ—Ä)
    async function openEditLessonModalManager(lessonId, teacherId) {
      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è
        const lessonResponse = await fetch(`/api/lesson/${lessonId}?tgId=${MY_TG_ID}&t=${Date.now()}`);
        if (!lessonResponse.ok) {
          showNotice('–ó–∞–Ω—è—Ç–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error');
          return;
        }
        const lesson = await lessonResponse.json();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —É—á–µ–Ω–∏–∫–æ–≤ –∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
        const teacherResponse = await fetch(`/api/manager/teacher/${teacherId}?tgId=${MY_TG_ID}&t=${Date.now()}`);
        const teacherData = await teacherResponse.json();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —É—á–µ–Ω–∏–∫–æ–≤ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
        const students = teacherData.students || [];
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–µ–¥–º–µ—Ç—ã –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
        const subjects = teacherData.subjects || [];
        
        const modal = document.createElement('div');
        modal.id = 'editLessonModalManager';
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.8);
          z-index: 1000;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 20px;
        `;
        
        modal.innerHTML = `
          <div style="
            background: #161b22;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            border: 1px solid #30363d;
          ">
            <div style="font-size: 20px; font-weight: 600; margin-bottom: 16px; color: white;">
              –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–Ω—è—Ç–∏–µ
            </div>
            <form id="editLessonFormManager" onsubmit="updateLessonManager(event, ${lessonId})">
              <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #c9d1d9;">–£—á–µ–Ω–∏–∫ *</label>
                <select id="editLessonStudentManager" required style="
                  width: 100%;
                  padding: 12px;
                  background: #21262d;
                  border: 1px solid #30363d;
                  border-radius: 8px;
                  color: white;
                  font-size: 14px;
                  box-sizing: border-box;
                ">
                  <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞</option>
                  ${students.map(s => `
                    <option value="${s.id}" ${s.id === lesson.student_id ? 'selected' : ''}>${s.first_name || ''} ${s.last_name || ''} ${s.class_name ? `(${s.class_name})` : ''}</option>
                  `).join('')}
                </select>
              </div>
              <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #c9d1d9;">–ü—Ä–µ–¥–º–µ—Ç</label>
                <select id="editLessonSubjectManager" style="
                  width: 100%;
                  padding: 12px;
                  background: #21262d;
                  border: 1px solid #30363d;
                  border-radius: 8px;
                  color: white;
                  font-size: 14px;
                  box-sizing: border-box;
                ">
                  <option value="">–ù–µ —É–∫–∞–∑–∞–Ω</option>
                  ${subjects.map(s => `
                    <option value="${s}" ${s === lesson.subject ? 'selected' : ''}>${s}</option>
                  `).join('')}
                </select>
              </div>
              <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #c9d1d9;">–î–∞—Ç–∞ *</label>
                <input type="date" id="editLessonDateManager" value="${lesson.lesson_date || lesson.date}" required style="
                  width: 100%;
                  padding: 12px;
                  background: #21262d;
                  border: 1px solid #30363d;
                  border-radius: 8px;
                  color: white;
                  font-size: 14px;
                  box-sizing: border-box;
                ">
              </div>
              <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                <div style="flex: 1;">
                  <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #c9d1d9;">–ù–∞—á–∞–ª–æ *</label>
                  <input type="time" id="editLessonStartTimeManager" value="${lesson.start_time}" required style="
                    width: 100%;
                    padding: 12px;
                    background: #21262d;
                    border: 1px solid #30363d;
                    border-radius: 8px;
                    color: white;
                    font-size: 14px;
                    box-sizing: border-box;
                  ">
                </div>
                <div style="flex: 1;">
                  <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #c9d1d9;">–û–∫–æ–Ω—á–∞–Ω–∏–µ *</label>
                  <input type="time" id="editLessonEndTimeManager" value="${lesson.end_time}" required style="
                    width: 100%;
                    padding: 12px;
                    background: #21262d;
                    border: 1px solid #30363d;
                    border-radius: 8px;
                    color: white;
                    font-size: 14px;
                    box-sizing: border-box;
                  ">
                </div>
              </div>
              <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #c9d1d9;">–ó–∞–º–µ—Ç–∫–∏</label>
                <textarea id="editLessonNotesManager" rows="3" style="
                  width: 100%;
                  padding: 12px;
                  background: #21262d;
                  border: 1px solid #30363d;
                  border-radius: 8px;
                  color: white;
                  font-size: 14px;
                  box-sizing: border-box;
                  resize: vertical;
                  font-family: inherit;
                ">${lesson.notes || ''}</textarea>
              </div>
              <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button type="button" onclick="closeEditLessonModalManager()" style="
                  flex: 1;
                  padding: 12px;
                  background: #21262d;
                  color: white;
                  border: none;
                  border-radius: 8px;
                  font-size: 14px;
                  font-weight: 600;
                  cursor: pointer;
                ">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" style="
                  flex: 1;
                  padding: 12px;
                  background: #1f6feb;
                  color: white;
                  border: none;
                  border-radius: 8px;
                  font-size: 14px;
                  font-weight: 600;
                  cursor: pointer;
                ">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              </div>
            </form>
          </div>
        `;
        
        document.body.appendChild(modal);
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
        showNotice('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∑–∞–Ω—è—Ç–∏—è', 'error');
      }
    }
    
    function closeEditLessonModalManager() {
      const modal = document.getElementById('editLessonModalManager');
      if (modal) {
        document.body.removeChild(modal);
      }
    }
    
    async function updateLessonManager(event, lessonId) {
      event.preventDefault();
      
      const studentId = document.getElementById('editLessonStudentManager').value;
      const subject = document.getElementById('editLessonSubjectManager').value;
      const lessonDate = document.getElementById('editLessonDateManager').value;
      const startTime = document.getElementById('editLessonStartTimeManager').value;
      const endTime = document.getElementById('editLessonEndTimeManager').value;
      const notes = document.getElementById('editLessonNotesManager').value.trim();
      
      if (!startTime || !endTime) {
        showNotice('–£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è', 'error');
        return;
      }
      
      if (startTime >= endTime) {
        showNotice('–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–∑–∂–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞', 'error');
        return;
      }
      
      try {
        const response = await fetch(`/api/lesson/${lessonId}?tgId=${MY_TG_ID}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            student_id: parseInt(studentId),
            subject: subject || null,
            lesson_date: lessonDate,
            start_time: startTime,
            end_time: endTime,
            notes: notes || null
          })
        });
        
        const result = await response.json();
        
        if (response.ok && result.ok) {
          showNotice('–ó–∞–Ω—è—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
          closeEditLessonModalManager();
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
          if (currentTeacherId) {
            loadStatistics();
          }
        } else {
          showNotice(result.error || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–Ω—è—Ç–∏—è', 'error');
        }
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–Ω—è—Ç–∏—è:', error);
        showNotice('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–Ω—è—Ç–∏—è', 'error');
      }
    }
    
    async function deleteLessonManager(lessonId) {
      if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –∑–∞–Ω—è—Ç–∏–µ?')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/lesson/${lessonId}?tgId=${MY_TG_ID}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (response.ok && result.ok) {
          showNotice('–ó–∞–Ω—è—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ', 'success');
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
          if (currentTeacherId) {
            loadStatistics();
          }
        } else {
          showNotice(result.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–Ω—è—Ç–∏—è', 'error');
        }
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–Ω—è—Ç–∏—è:', error);
        showNotice('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–Ω—è—Ç–∏—è', 'error');
      }
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    async function init() {
      await loadUser();
      await loadTeachers();
    }
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    window.loadTeachers = loadTeachers;
    window.showTeacherDetail = showTeacherDetail;
    window.showTeacherTab = showTeacherTab;
    window.loadStatistics = loadStatistics;
    window.openEditLessonModalManager = openEditLessonModalManager;
    window.closeEditLessonModalManager = closeEditLessonModalManager;
    window.updateLessonManager = updateLessonManager;
    window.deleteLessonManager = deleteLessonManager;
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å–∫—Ä—ã—Ç–∏—è/—Å–∫—Ä—ã—Ç–∏—è –¥–µ—Ç–∞–ª–µ–π –∑–∞–Ω—è—Ç–∏–π —É—á–µ–Ω–∏–∫–∞
    function toggleStudentDetails(studentId, arrowId) {
      const detailsDiv = document.getElementById(studentId);
      const arrowDiv = document.getElementById(arrowId);
      
      if (detailsDiv) {
        if (detailsDiv.style.display === 'none' || !detailsDiv.style.display) {
          detailsDiv.style.display = 'block';
          if (arrowDiv) {
            arrowDiv.textContent = '‚ñº';
            arrowDiv.style.transform = 'rotate(0deg)';
          }
        } else {
          detailsDiv.style.display = 'none';
          if (arrowDiv) {
            arrowDiv.textContent = '‚ñ∂';
            arrowDiv.style.transform = 'rotate(0deg)';
          }
        }
      }
    }
    window.toggleStudentDetails = toggleStudentDetails;
    window.openAddStudentModal = openAddStudentModal;
    window.closeAddStudentModal = closeAddStudentModal;
    window.addStudent = addStudent;
    
    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É—á–µ–Ω–∏–∫–∞
    function openEditStudentModal(studentId, firstName, lastName, className) {
      document.getElementById('editStudentId').value = studentId;
      document.getElementById('editStudentFirstName').value = firstName;
      document.getElementById('editStudentLastName').value = lastName || '';
      document.getElementById('editStudentClass').value = className || '';
      document.getElementById('editStudentModal').classList.add('active');
      document.getElementById('editStudentFirstName').focus();
    }
    
    function closeEditStudentModal() {
      document.getElementById('editStudentModal').classList.remove('active');
      document.getElementById('editStudentForm').reset();
    }
    
    async function updateStudent(event) {
      event.preventDefault();
      
      const studentId = document.getElementById('editStudentId').value;
      const firstName = document.getElementById('editStudentFirstName').value.trim();
      const lastName = document.getElementById('editStudentLastName').value.trim();
      const className = document.getElementById('editStudentClass').value.trim();
      
      try {
        const response = await fetch(
          `/api/manager/student/${studentId}?tgId=${MY_TG_ID}`,
          {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              first_name: firstName,
              last_name: lastName,
              class_name: className || null
            })
          }
        );
        
        const result = await response.json();
        
        if (response.ok && result.ok) {
          showNotice('–£—á–µ–Ω–∏–∫ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
          closeEditStudentModal();
          // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
          showTeacherDetail(currentTeacherId);
        } else {
          showNotice(result.error || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —É—á–µ–Ω–∏–∫–∞', 'error');
        }
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —É—á–µ–Ω–∏–∫–∞:', error);
        showNotice('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —É—á–µ–Ω–∏–∫–∞', 'error');
      }
    }
    
    async function deleteStudent(studentId) {
      if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ —É—á–µ–Ω–∏–∫–∞ —É –¥–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è?')) {
        return;
      }
      
      try {
        const response = await fetch(
          `/api/manager/teacher/${currentTeacherId}/student/${studentId}?tgId=${MY_TG_ID}`,
          {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
          }
        );
        
        const result = await response.json();
        
        if (response.ok && result.ok) {
          showNotice('–£—á–µ–Ω–∏–∫ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω', 'success');
          // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
          showTeacherDetail(currentTeacherId);
        } else {
          showNotice(result.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —É—á–µ–Ω–∏–∫–∞', 'error');
        }
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —É—á–µ–Ω–∏–∫–∞:', error);
        showNotice('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —É—á–µ–Ω–∏–∫–∞', 'error');
      }
    }
    
    window.openEditStudentModal = openEditStudentModal;
    window.closeEditStudentModal = closeEditStudentModal;
    window.updateStudent = updateStudent;
    window.deleteStudent = deleteStudent;
    
    // –ó–∞–ø—É—Å–∫
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
