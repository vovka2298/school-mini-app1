<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>–ö–∞–±–∏–Ω–µ—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìÖ</text></svg>">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      margin: 0;
      background: #0d1117;
      color: #c9d1d9;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    .header {
      background: #161b22;
      padding: 16px;
      border-bottom: 1px solid #30363d;
    }
    
    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    
    .avatar {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      border: 3px solid #58a6ff;
      background: #21262d;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    
    .refresh-btn {
      background: #238636;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }
    
    .refresh-btn:hover {
      background: #2ea043;
    }
    
    .refresh-btn:active {
      transform: scale(0.98);
    }
    
    .tabs {
      display: flex;
      background: #161b22;
      border-bottom: 1px solid #30363d;
    }
    
    .tab {
      flex: 1;
      padding: 16px;
      text-align: center;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      user-select: none;
    }
    
    .tab.active {
      background: #1f6feb;
      color: white;
    }
    
    .legend {
      padding: 14px;
      background: #161b22;
      display: flex;
      justify-content: center;
      gap: 24px;
      font-size: 13px;
      flex-wrap: wrap;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .legend-box {
      width: 16px;
      height: 16px;
      border-radius: 6px;
    }
    
    .content {
      padding: 12px;
      height: calc(100vh - 250px);
      overflow-y: auto;
      position: relative;
    }
    
    .week-header {
      display: flex;
      margin-left: 68px;
      margin-bottom: 8px;
      font-size: 12px;
      color: #8b949e;
    }
    
    .day-name {
      width: 88px;
      text-align: center;
      flex: none;
    }
    
    .time-row {
      display: flex;
      align-items: center;
      margin: 3px 0;
    }
    
    .time-label {
      width: 68px;
      text-align: right;
      font-size: 13px;
      color: #8b949e;
      padding-right: 12px;
      flex: none;
    }
    
    .slots {
      display: flex;
      flex: 1;
    }
    
    .slot {
      width: 80px;
      height: 56px;
      margin: 0 4px;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      overflow: hidden;
      user-select: none;
    }
    
    .slot:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .state-0 { background: #21262d; color: #8b949e; }
    .state-1 { background: #238636; color: white; }
    .state-2 { background: #da3633; color: white; }
    
    .slot-time {
      font-size: 9px;
      opacity: 0.8;
      margin-bottom: 3px;
    }
    
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #8b949e;
      font-size: 16px;
    }
    
    .error {
      text-align: center;
      padding: 60px 20px;
      color: #da3633;
    }
    
    .sync-notice {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #1f6feb;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      animation: fadeIn 0.3s;
      z-index: 1000;
    }
    
    .cache-notice {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: #ffa500;
      color: #000;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      animation: fadeIn 0.3s;
      z-index: 1000;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    button {
      font-family: inherit;
    }
    
    #lastSync {
      font-size: 11px;
      color: #8b949e;
      text-align: center;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-top">
      <div class="user-info">
        <div class="avatar">üë®‚Äçüè´</div>
        <div>
          <h3 id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</h3>
          <p>–ö–∞–±–∏–Ω–µ—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</p>
        </div>
      </div>
      <button class="refresh-btn" id="refreshBtn" onclick="forceRefresh()">
        üîÑ –û–±–Ω–æ–≤–∏—Ç—å
      </button>
    </div>
    <div id="lastSync"></div>
  </div>
  
  <div class="tabs">
    <div class="tab active" onclick="showSchedule()">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
    <div class="tab" onclick="showBookings()">–£—á–µ–Ω–∏–∫–∏</div>
    <div class="tab" onclick="showLessons()">–ó–∞–Ω—è—Ç–∏—è</div>
    <div class="tab" onclick="showSubjects()">–ü—Ä–µ–¥–º–µ—Ç—ã</div>
  </div>
  
  <div style="padding: 8px 16px; background: #161b22; border-bottom: 1px solid #30363d; display: flex; justify-content: flex-start; align-items: center;">
    <button onclick="showCalendarView()" style="
      background: #1f6feb;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    " onmouseover="this.style.background='#1565c0'" onmouseout="this.style.background='#1f6feb'">
      üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å
    </button>
  </div>
  
  <div class="legend">
    <div class="legend-item"><div class="legend-box" style="background:#21262d"></div>–ù–µ —Ä–∞–±–æ—Ç–∞—é</div>
    <div class="legend-item"><div class="legend-box" style="background:#238636"></div>–°–≤–æ–±–æ–¥–µ–Ω</div>
    <div class="legend-item"><div class="legend-box" style="background:#da3633"></div>–ó–∞–Ω—è—Ç</div>
  </div>
  
  <div id="occupancyStats" style="
    padding: 12px 16px;
    background: #161b22;
    border-bottom: 1px solid #30363d;
    text-align: center;
    font-size: 14px;
    color: #c9d1d9;
    display: none;
  ">
    <div style="display: flex; justify-content: center; align-items: center; gap: 8px;">
      <span style="color: #58a6ff; font-weight: 600;">‚è∞ –ó–∞–Ω—è—Ç–æ—Å—Ç—å –∑–∞ –Ω–µ–¥–µ–ª—é:</span>
      <span id="weeklyHours" style="color: white; font-weight: 600;">0 —á</span>
    </div>
  </div>
  
  <div class="content" id="content">
    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è...</div>
  </div>

  <script>
    // Telegram Web App
    if (typeof Telegram !== 'undefined') {
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã - –µ—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º
    (async function checkRoleOnLoad() {
      try {
        function getTelegramIdFromURL() {
          const params = new URLSearchParams(window.location.search);
          if (params.get('tgId')) return params.get('tgId');
          if (typeof Telegram !== 'undefined' && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
            return Telegram.WebApp.initDataUnsafe.user.id.toString();
          }
          return null;
        }
        
        const tgId = getTelegramIdFromURL();
        if (tgId) {
          const response = await fetch(`/api/user?tgId=${tgId}&t=${Date.now()}`);
          const user = await response.json();
          
          // –ï—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä, —Å—Ä–∞–∑—É –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º
          if (user.role === 'manager' || (user.role && user.role.toLowerCase().includes('manager'))) {
            console.log('‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω –º–µ–Ω–µ–¥–∂–µ—Ä –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ manager.html');
            window.location.replace(`/manager.html?tgId=${tgId}`);
            return;
          }
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:', error);
      }
    })();
    
    // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
    const DAYS = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
    const FULL_DAYS = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];
    const TIMES = [];
    for (let h = 8; h <= 22; h++) {
      TIMES.push(`${h.toString().padStart(2, '0')}:00`);
      if (h < 22) TIMES.push(`${h.toString().padStart(2, '0')}:30`);
    }
    const TEXTS = ['–ù–µ —Ä–∞–±–æ—Ç–∞—é', '–°–≤–æ–±–æ–¥–µ–Ω', '–ó–∞–Ω—è—Ç'];
    
    // –î–∞–Ω–Ω—ã–µ
    let schedule = {};
    let lastScheduleHash = '';
    let isSaving = false;
    let lastUpdateTime = 0;
    
    // –ü–æ–ª—É—á–∏—Ç—å telegram_id –∏–∑ Telegram Web App
    function getTelegramId() {
      if (typeof Telegram !== 'undefined' && Telegram.WebApp && Telegram.WebApp.initDataUnsafe) {
        const user = Telegram.WebApp.initDataUnsafe.user;
        if (user && user.id) {
          return user.id.toString();
        }
      }
      // Fallback –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
      return '913096324';
    }
    
    const MY_ID = getTelegramId();
    const STORAGE_KEY = 'teacher_schedule_v2';
    const CACHE_TTL = 30000; // 30 —Å–µ–∫—É–Ω–¥
    
    // ===== –£–¢–ò–õ–ò–¢–´ =====
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ö—ç—à–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    function getScheduleHash(sched) {
      let hash = '';
      FULL_DAYS.forEach(day => {
        TIMES.forEach(time => {
          const slotValue = sched[day]?.[time] || 0;
          const state = typeof slotValue === 'object' ? slotValue.status : slotValue;
          const studentName = typeof slotValue === 'object' && slotValue.student_name ? slotValue.student_name : '';
          hash += `${day}-${time}:${state}:${studentName}|`;
        });
      });
      return hash;
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫–µ—à
    function saveToCache(data) {
      try {
        const cache = {
          data: data,
          timestamp: Date.now(),
          hash: getScheduleHash(data)
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(cache));
      } catch (e) {
        console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫–µ—à:", e);
      }
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –∫–µ—à–∞
    function loadFromCache() {
      try {
        const cached = localStorage.getItem(STORAGE_KEY);
        if (!cached) return null;
        
        const cache = JSON.parse(cached);
        const now = Date.now();
        
        if (now - cache.timestamp < CACHE_TTL) {
          return cache.data;
        }
      } catch (e) {
        console.warn("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ –∫–µ—à–∞:", e);
      }
      return null;
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    function showNotice(text, color = '#1f6feb', duration = 2000) {
      const notice = document.createElement('div');
      notice.className = 'sync-notice';
      notice.style.background = color;
      notice.textContent = text;
      document.body.appendChild(notice);
      
      setTimeout(() => {
        notice.style.opacity = '0';
        notice.style.transform = 'translateY(10px)';
        setTimeout(() => document.body.removeChild(notice), 300);
      }, duration);
    }
    
    // –û–±–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
    function updateLastSyncTime() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('ru-RU', { 
        hour: '2-digit', 
        minute: '2-digit',
        second: '2-digit'
      });
      document.getElementById('lastSync').textContent = `–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${timeStr}`;
    }
    
    // ===== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò =====
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    async function loadSchedule(force = false) {
      try {
        const refreshBtn = document.getElementById('refreshBtn');
        refreshBtn.disabled = true;
        refreshBtn.textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';
        
        // –ï—Å–ª–∏ –Ω–µ —Ñ–æ—Ä—Å–∏—Ä—É–µ–º –∏ –µ—Å—Ç—å –∫–µ—à - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ
        if (!force) {
          const cached = loadFromCache();
          if (cached) {
            schedule = cached;
            renderSchedule();
            showNotice("–î–∞–Ω–Ω—ã–µ –∏–∑ –∫–µ—à–∞", "#ffa500", 1500);
          }
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å —Å–µ—Ä–≤–µ—Ä–∞
        const url = `/api/my-schedule?tgId=${MY_ID}&t=${Date.now()}`;
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`–û—à–∏–±–∫–∞ ${response.status}`);
        }
        
        const data = await response.json();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ª–∏ –¥–∞–Ω–Ω—ã–µ
        const newHash = getScheduleHash(data);
        const shouldUpdate = force || newHash !== lastScheduleHash;
        
        if (shouldUpdate) {
          schedule = data;
          lastScheduleHash = newHash;
          lastUpdateTime = data._timestamp || Date.now();
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à
          saveToCache(data);
          
          // –†–µ–Ω–¥–µ—Ä–∏–º
          renderSchedule();
          updateLastSyncTime();
          
          if (!force) {
            showNotice("–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ");
          }
          
          console.log("‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ (—Å–µ—Ä–≤–µ—Ä)");
        } else {
          console.log("‚ÑπÔ∏è –î–∞–Ω–Ω—ã–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å");
        }
        
      } catch (error) {
        console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", error);
        
        // –ü—Ä–æ–±—É–µ–º –ø–æ–∫–∞–∑–∞—Ç—å –∫–µ—à –ø—Ä–∏ –æ—à–∏–±–∫–µ
        const cached = loadFromCache();
        if (cached && Object.keys(cached).length > 0) {
          schedule = cached;
          renderSchedule();
          showNotice("–û—Ñ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º (–¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–µ—à–∞)", "#ffa500", 3000);
        } else {
          document.getElementById('content').innerHTML = `
            <div class="error">
              –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
              <br>
              <button onclick="forceRefresh()" style="margin-top: 20px;">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
            </div>
          `;
        }
      } finally {
        const refreshBtn = document.getElementById('refreshBtn');
        refreshBtn.disabled = false;
        refreshBtn.textContent = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å';
      }
    }
    
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    async function forceRefresh() {
      showNotice("–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ...", "#1f6feb");
      await loadSchedule(true);
    }
    
    // –ü–æ–¥—Å—á–µ—Ç –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ (–∫—Ä–∞—Å–Ω—ã–µ –∫–≤–∞–¥—Ä–∞—Ç–∏–∫–∏ - —Å—Ç–∞—Ç—É—Å 2)
    function calculateOccupancy() {
      let occupiedSlots = 0;
      
      FULL_DAYS.forEach(day => {
        TIMES.forEach(time => {
          const slotValue = schedule[day]?.[time] || 0;
          const state = typeof slotValue === 'object' ? slotValue.status : slotValue;
          if (state === 2) {
            occupiedSlots++;
          }
        });
      });
      
      // –ö–∞–∂–¥—ã–π —Å–ª–æ—Ç = 30 –º–∏–Ω—É—Ç
      const totalMinutes = occupiedSlots * 30;
      const hours = Math.floor(totalMinutes / 60);
      const minutes = totalMinutes % 60;
      
      // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
      const statsDiv = document.getElementById('occupancyStats');
      const hoursSpan = document.getElementById('weeklyHours');
      
      if (statsDiv && hoursSpan) {
        statsDiv.style.display = 'block';
        
        if (hours > 0 && minutes > 0) {
          hoursSpan.textContent = `${hours} —á ${minutes} –º`;
        } else if (hours > 0) {
          hoursSpan.textContent = `${hours} —á`;
        } else if (minutes > 0) {
          hoursSpan.textContent = `${minutes} –º`;
        } else {
          hoursSpan.textContent = '0 —á';
        }
      }
      
      return { occupiedSlots, totalMinutes, hours, minutes };
    }
    
    // –†–µ–Ω–¥–µ—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    function renderSchedule() {
      if (Object.keys(schedule).length === 0) {
        document.getElementById('content').innerHTML = `
          <div class="loading">
            –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø—É—Å—Ç–æ–µ. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —è—á–µ–π–∫–∏, —á—Ç–æ–±—ã –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å.
          </div>
        `;
        // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É, –µ—Å–ª–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø—É—Å—Ç–æ–µ
        const statsDiv = document.getElementById('occupancyStats');
        if (statsDiv) statsDiv.style.display = 'none';
        return;
      }
      
      let html = '<div class="week-header"><div></div>';
      DAYS.forEach(d => html += `<div class="day-name">${d}</div>`);
      html += '</div>';
      
      TIMES.forEach(time => {
        html += `<div class="time-row"><div class="time-label">${time}</div><div class="slots">`;
        DAYS.forEach((_, i) => {
          const day = FULL_DAYS[i];
          const slotValue = schedule[day]?.[time] || 0;
          const state = typeof slotValue === 'object' ? slotValue.status : slotValue;
          const studentName = typeof slotValue === 'object' && slotValue.student_name ? slotValue.student_name : null;
          const slotId = `slot-${day}-${time}`;
          html += `<div class="slot state-${state}" id="${slotId}" 
                   onclick="toggleSlot('${day}', '${time}', this)"
                   oncontextmenu="handleSlotLongPress(event, '${day}', '${time}', ${state}); return false;"
                   ontouchstart="handleSlotTouchStart(event, '${day}', '${time}', ${state})"
                   ontouchend="handleSlotTouchEnd(event)"
                   ontouchmove="handleSlotTouchEnd(event)">
            <div class="slot-time">${time}</div>
            <div>${TEXTS[state]}</div>
            ${studentName ? `<div style="font-size: 9px; margin-top: 4px; opacity: 0.9; line-height: 1.2;">${studentName}</div>` : ''}
          </div>`;
        });
        html += '</div></div>';
      });
      
      document.getElementById('content').innerHTML = html;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞
      calculateOccupancy();
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —è—á–µ–π–∫–∏
    async function toggleSlot(day, time, element) {
      if (isSaving) {
        showNotice("–ü–æ–¥–æ–∂–¥–∏—Ç–µ, –∏–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...", "#ffa500", 1000);
        return;
      }
      
      isSaving = true;
      
      try {
        // –õ–æ–∫–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        if (!schedule[day]) schedule[day] = {};
        const currentValue = schedule[day][time] || 0;
        const current = typeof currentValue === 'object' ? currentValue.status : currentValue;
        const next = (current + 1) % 3;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è —É—á–µ–Ω–∏–∫–∞, –µ—Å–ª–∏ –æ–Ω–æ –±—ã–ª–æ
        const studentName = typeof currentValue === 'object' && currentValue.student_name ? currentValue.student_name : null;
        if (next === 2 && studentName) {
          schedule[day][time] = { status: next, student_name: studentName };
        } else if (next === 2) {
          schedule[day][time] = next;
        } else {
          schedule[day][time] = next;
        }
        
        // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
        element.className = `slot state-${next}`;
        const textDiv = element.querySelectorAll('div')[1]; // –í—Ç–æ—Ä–æ–π div —Å —Ç–µ–∫—Å—Ç–æ–º
        if (textDiv) {
          textDiv.textContent = TEXTS[next];
        }
        
        // –£–¥–∞–ª—è–µ–º –∏–º—è —É—á–µ–Ω–∏–∫–∞, –µ—Å–ª–∏ —è—á–µ–π–∫–∞ –Ω–µ –∑–∞–Ω—è—Ç–∞
        const nameDiv = element.querySelectorAll('div')[2];
        if (nameDiv && next !== 2) {
          nameDiv.remove();
        } else if (next === 2 && studentName && !nameDiv) {
          // –î–æ–±–∞–≤–ª—è–µ–º –∏–º—è —É—á–µ–Ω–∏–∫–∞, –µ—Å–ª–∏ —è—á–µ–π–∫–∞ –∑–∞–Ω—è—Ç–∞ –∏ –∏–º—è –µ—Å—Ç—å
          const newNameDiv = document.createElement('div');
          newNameDiv.style.cssText = 'font-size: 9px; margin-top: 4px; opacity: 0.9; line-height: 1.2;';
          newNameDiv.textContent = studentName;
          element.appendChild(newNameDiv);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞–Ω—è—Ç–æ—Å—Ç–∏
        calculateOccupancy();
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à —Å—Ä–∞–∑—É
        saveToCache(schedule);
        lastScheduleHash = getScheduleHash(schedule);
        
        // –û—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        setTimeout(async () => {
          try {
            const response = await fetch(`/api/schedule/${MY_ID}?tgId=${MY_ID}&t=${Date.now()}`, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify(schedule)
            });
            
            const result = await response.json();
            if (result.ok) {
              showNotice("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ", "#238636", 1000);
              lastUpdateTime = result._timestamp || Date.now();
              updateLastSyncTime();
            }
          } catch (saveError) {
            console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä:", saveError);
            showNotice("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏", "#da3633", 2000);
          }
        }, 500); // –ó–∞–¥–µ—Ä–∂–∫–∞ 500ms –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        
      } finally {
        setTimeout(() => {
          isSaving = false;
        }, 300);
      }
    }
    
    // –í–∫–ª–∞–¥–∫–∏
    function showSchedule() {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab')[0].classList.add('active');
      loadSchedule();
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–µ–Ω–∏–∫–æ–≤
    async function showBookings() {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab')[1].classList.add('active');
      
      document.getElementById('content').innerHTML = `
        <div class="loading">
          –ó–∞–≥—Ä—É–∑–∫–∞ —É—á–µ–Ω–∏–∫–æ–≤...
        </div>
      `;
      
      try {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É—á–µ–Ω–∏–∫–æ–≤
        const response = await fetch(`/api/teacher/students?tgId=${MY_ID}&t=${Date.now()}`);
        const data = await response.json();
        
        if (!data.students || data.students.length === 0) {
          document.getElementById('content').innerHTML = `
            <div class="loading">
              –ù–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤
            </div>
          `;
          return;
        }
        
        let html = '<div style="padding: 16px;">';
        html += '<h3 style="margin-top: 0; margin-bottom: 16px;">–ú–û–ò –£–ß–ï–ù–ò–ö–ò</h3>';
        
        data.students.forEach(student => {
          const fullName = `${student.first_name || ''} ${student.last_name || ''}`.trim() || student.first_name || '–ë–µ–∑ –∏–º–µ–Ω–∏';
          const className = student.class_name ? ` ‚Ä¢ ${student.class_name}` : '';
          
          html += `
            <div style="
              background: #161b22;
              border-radius: 12px;
              padding: 16px;
              margin-bottom: 12px;
              border-left: 4px solid #238636;
            ">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong style="font-size: 16px;">${fullName}</strong>
                  ${className ? `
                    <div style="font-size: 14px; color: #8b949e; margin-top: 4px;">
                      üè´ –ö–ª–∞—Å—Å: ${student.class_name}
                    </div>
                  ` : ''}
                </div>
                <div style="text-align: right;">
                  <div style="
                    background: #238636;
                    color: white;
                    padding: 4px 12px;
                    border-radius: 20px;
                    font-size: 12px;
                    display: inline-block;
                  ">
                    –£—á–µ–Ω–∏–∫
                  </div>
                </div>
              </div>
            </div>
          `;
        });
        
        html += '</div>';
        document.getElementById('content').innerHTML = html;
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–µ–Ω–∏–∫–æ–≤:', error);
        document.getElementById('content').innerHTML = `
          <div class="loading">
            –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–µ–Ω–∏–∫–æ–≤
            <button onclick="showBookings()" style="margin-top: 20px;">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
          </div>
        `;
      }
    }
    
    // –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞—è–≤–æ–∫ (–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
    async function showBookingsOld() {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab')[1].classList.add('active');
      
      document.getElementById('content').innerHTML = `
        <div class="loading">
          –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫...
        </div>
      `;
      
      try {
        const response = await fetch(`/api/bookings/${MY_ID}?tgId=${MY_ID}&t=${Date.now()}`);
        const data = await response.json();
        
        if (data.bookings.length === 0) {
          document.getElementById('content').innerHTML = `
            <div class="loading">
              –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫
            </div>
          `;
          return;
        }
        
        let html = '<div style="padding: 16px;">';
        html += '<h3 style="margin-top: 0; margin-bottom: 16px;">–ó–ê–Ø–í–ö–ò –û–¢ –£–ß–ï–ù–ò–ö–û–í</h3>';
        
        data.bookings.forEach(booking => {
          const statusColors = {
            'pending': '#ffa500',
            'confirmed': '#238636',
            'cancelled': '#da3633',
            'completed': '#8b949e'
          };
          
          const statusTexts = {
            'pending': '–û–∂–∏–¥–∞–Ω–∏–µ',
            'confirmed': '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ',
            'cancelled': '–û—Ç–º–µ–Ω–µ–Ω–æ',
            'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω–æ'
          };
          
          html += `
            <div style="
              background: #161b22;
              border-radius: 12px;
              padding: 16px;
              margin-bottom: 12px;
              border-left: 4px solid ${statusColors[booking.status] || '#8b949e'};
            ">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong>${booking.first_name} ${booking.last_name || ''}</strong>
                  <div style="font-size: 14px; color: #8b949e; margin-top: 4px;">
                    üìÖ ${booking.day}, ${booking.time_slot}
                  </div>
                  <div style="font-size: 14px; margin-top: 4px;">
                    –ü—Ä–µ–¥–º–µ—Ç: ${booking.subject || '–ù–µ —É–∫–∞–∑–∞–Ω'}
                  </div>
                </div>
                <div style="text-align: right;">
                  <div style="
                    background: ${statusColors[booking.status] || '#8b949e'};
                    color: white;
                    padding: 4px 12px;
                    border-radius: 20px;
                    font-size: 12px;
                    display: inline-block;
                  ">
                    ${statusTexts[booking.status] || booking.status}
                  </div>
                  ${booking.status === 'pending' ? `
                    <div style="margin-top: 8px;">
                      <button onclick="updateBooking(${booking.id}, 'confirmed')" 
                        style="
                          background: #238636;
                          color: white;
                          border: none;
                          padding: 6px 12px;
                          border-radius: 6px;
                          font-size: 12px;
                          margin-right: 4px;
                          cursor: pointer;
                        ">
                        ‚úì –ü—Ä–∏–Ω—è—Ç—å
                      </button>
                      <button onclick="updateBooking(${booking.id}, 'cancelled')"
                        style="
                          background: #da3633;
                          color: white;
                          border: none;
                          padding: 6px 12px;
                          border-radius: 6px;
                          font-size: 12px;
                          cursor: pointer;
                        ">
                        ‚úï –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                      </button>
                    </div>
                  ` : ''}
                </div>
              </div>
              <div style="font-size: 12px; color: #8b949e; margin-top: 8px;">
                –°–æ–∑–¥–∞–Ω–æ: ${new Date(booking.created_at).toLocaleDateString('ru-RU')}
              </div>
            </div>
          `;
        });
        
        html += '</div>';
        document.getElementById('content').innerHTML = html;
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫:', error);
        document.getElementById('content').innerHTML = `
          <div class="error">
            –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫
            <br>
            <button onclick="showBookings()" style="margin-top: 20px;">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
          </div>
        `;
      }
    }
    
    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞—è–≤–∫–∏
    window.updateBooking = async function(bookingId, status) {
      try {
        const response = await fetch(`/api/booking/${bookingId}/status?t=${Date.now()}`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ status })
        });
        
        if (response.ok) {
          showNotice(`–ó–∞—è–≤–∫–∞ ${status === 'confirmed' ? '–ø—Ä–∏–Ω—è—Ç–∞' : '–æ—Ç–∫–ª–æ–Ω–µ–Ω–∞'}`, 
                    status === 'confirmed' ? '#238636' : '#da3633');
          showBookings();
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∏:', error);
        showNotice('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', '#da3633');
      }
    };
    
    function showSubjects() {
      window.location.href = '/subjects.html';
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–Ω—è—Ç–∏–π
    async function showLessons() {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab')[2].classList.add('active');
      
      document.getElementById('content').innerHTML = `
        <div class="loading">
          –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
        </div>
      `;
      
      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —É—á–µ–Ω–∏–∫–æ–≤
        const studentsResponse = await fetch(`/api/teacher/students?tgId=${MY_ID}&t=${Date.now()}`);
        const studentsData = await studentsResponse.json();
        const students = studentsData.students || [];
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–µ–¥–º–µ—Ç—ã
        const profileResponse = await fetch(`/api/profile/${MY_ID}?tgId=${MY_ID}&t=${Date.now()}`);
        const profileData = await profileResponse.json();
        const subjects = profileData.subjects || [];
        
        let html = `
          <div style="padding: 16px;">
            <h3 style="margin-top: 0; margin-bottom: 16px;">–ü—Ä–æ–≤–µ–¥–µ–Ω–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è</h3>
            
            <button onclick="openAddLessonModal()" style="
              background: #238636;
              color: white;
              border: none;
              padding: 12px 20px;
              border-radius: 8px;
              font-size: 14px;
              cursor: pointer;
              margin-bottom: 16px;
              width: 100%;
            ">
              + –î–æ–±–∞–≤–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ
            </button>
            
            <div id="lessonsList" style="color: #8b949e; text-align: center; padding: 40px;">
              –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–Ω—è—Ç–∏–π...
            </div>
          </div>
        `;
        
        document.getElementById('content').innerHTML = html;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        window.lessonsStudents = students;
        window.lessonsSubjects = subjects;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—ã—Ö –∑–∞–Ω—è—Ç–∏–π
        try {
          const lessonsResponse = await fetch(`/api/teacher/lessons?tgId=${MY_ID}&t=${Date.now()}`);
          const lessonsData = await lessonsResponse.json();
          const lessons = lessonsData.lessons || [];
          
          const studentsMap = {};
          students.forEach(s => { studentsMap[s.id] = s; });
          
          if (lessons.length === 0) {
            document.getElementById('lessonsList').innerHTML = `
              <div style="color: #8b949e; text-align: center; padding: 40px;">
                –ù–µ—Ç –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—ã—Ö –∑–∞–Ω—è—Ç–∏–π
              </div>
            `;
          } else {
            let lessonsHtml = '';
            lessons.forEach(lesson => {
              const student = lesson.student || studentsMap[lesson.student_id];
              const studentName = student ? `${student.first_name || ''} ${student.last_name || ''}`.trim() : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —É—á–µ–Ω–∏–∫';
              const duration = lesson.duration_minutes || 0;
              const hours = Math.floor(duration / 60);
              const minutes = duration % 60;
              const durationText = hours > 0 ? `${hours}—á ${minutes}–º` : `${minutes}–º`;
              
              lessonsHtml += `
                <div style="
                  background: #161b22;
                  border-radius: 12px;
                  padding: 16px;
                  margin-bottom: 12px;
                  border-left: 4px solid #238636;
                  position: relative;
                ">
                  <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1; padding-right: 50px;">
                      <strong style="font-size: 16px;">${studentName}</strong>
                      <div style="font-size: 14px; color: #8b949e; margin-top: 8px;">
                        üìÖ ${new Date(lesson.lesson_date).toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' })}
                      </div>
                      <div style="font-size: 14px; color: #8b949e; margin-top: 4px;">
                        ‚è∞ ${lesson.start_time} - ${lesson.end_time} (${durationText})
                      </div>
                      ${lesson.subject ? `
                        <div style="font-size: 14px; color: #58a6ff; margin-top: 4px;">
                          üìö ${lesson.subject}
                        </div>
                      ` : ''}
                      ${lesson.notes ? `
                        <div style="font-size: 13px; color: #8b949e; margin-top: 8px; padding-top: 8px; border-top: 1px solid #30363d;">
                          ${lesson.notes}
                        </div>
                      ` : ''}
                    </div>
                    <div style="
                      position: absolute;
                      top: 12px;
                      right: 12px;
                      display: flex;
                      gap: 6px;
                    ">
                      <button onclick="openEditLessonModal(${lesson.id})" style="
                        background: #1f6feb;
                        color: white;
                        border: none;
                        padding: 6px 8px;
                        border-radius: 6px;
                        font-size: 16px;
                        cursor: pointer;
                        width: 32px;
                        height: 32px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: background 0.2s;
                        flex-shrink: 0;
                      " onmouseover="this.style.background='#1565c0'" onmouseout="this.style.background='#1f6feb'">‚úèÔ∏è</button>
                      <button onclick="deleteLesson(${lesson.id})" style="
                        background: #da3633;
                        color: white;
                        border: none;
                        padding: 6px 8px;
                        border-radius: 6px;
                        font-size: 16px;
                        cursor: pointer;
                        width: 32px;
                        height: 32px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: background 0.2s;
                        flex-shrink: 0;
                      " onmouseover="this.style.background='#c62828'" onmouseout="this.style.background='#da3633'">üóëÔ∏è</button>
                    </div>
                  </div>
                </div>
              `;
            });
            document.getElementById('lessonsList').innerHTML = lessonsHtml;
          }
        } catch (lessonsError) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–Ω—è—Ç–∏–π:', lessonsError);
          document.getElementById('lessonsList').innerHTML = `
            <div style="color: #da3633; text-align: center; padding: 40px;">
              –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–Ω—è—Ç–∏–π
            </div>
          `;
        }
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
        document.getElementById('content').innerHTML = `
          <div class="error">
            –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
            <br>
            <button onclick="showLessons()" style="margin-top: 20px;">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
          </div>
        `;
      }
    }
    
    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–Ω—è—Ç–∏—è
    function openAddLessonModal() {
      const students = window.lessonsStudents || [];
      const subjects = window.lessonsSubjects || [];
      
      if (students.length === 0) {
        showNotice('–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —É—á–µ–Ω–∏–∫–æ–≤ —á–µ—Ä–µ–∑ –º–µ–Ω–µ–¥–∂–µ—Ä–∞', 'error');
        return;
      }
      
      const today = new Date().toISOString().split('T')[0];
      const now = new Date();
      const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
      
      const modal = document.createElement('div');
      modal.id = 'addLessonModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      `;
      
      modal.innerHTML = `
        <div style="
          background: #161b22;
          border-radius: 12px;
          padding: 24px;
          max-width: 400px;
          width: 100%;
          border: 1px solid #30363d;
        ">
          <div style="font-size: 20px; font-weight: 600; margin-bottom: 16px; color: white;">
            –î–æ–±–∞–≤–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ
          </div>
          <form id="addLessonForm" onsubmit="saveLesson(event)">
            <div style="margin-bottom: 16px;">
              <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #c9d1d9;">–£—á–µ–Ω–∏–∫ *</label>
              <select id="lessonStudent" required style="
                width: 100%;
                padding: 12px;
                background: #21262d;
                border: 1px solid #30363d;
                border-radius: 8px;
                color: white;
                font-size: 14px;
                box-sizing: border-box;
              ">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞</option>
                ${students.map(s => `
                  <option value="${s.id}">${s.first_name} ${s.last_name || ''} ${s.class_name ? `(${s.class_name})` : ''}</option>
                `).join('')}
              </select>
            </div>
            <div style="margin-bottom: 16px;">
              <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #c9d1d9;">–ü—Ä–µ–¥–º–µ—Ç</label>
              <select id="lessonSubject" style="
                width: 100%;
                padding: 12px;
                background: #21262d;
                border: 1px solid #30363d;
                border-radius: 8px;
                color: white;
                font-size: 14px;
                box-sizing: border-box;
              ">
                <option value="">–ù–µ —É–∫–∞–∑–∞–Ω</option>
                ${subjects.map(s => `<option value="${s}">${s}</option>`).join('')}
              </select>
            </div>
            <div style="margin-bottom: 16px;">
              <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #c9d1d9;">–î–∞—Ç–∞ *</label>
              <input type="date" id="lessonDate" value="${today}" required style="
                width: 100%;
                padding: 12px;
                background: #21262d;
                border: 1px solid #30363d;
                border-radius: 8px;
                color: white;
                font-size: 14px;
                box-sizing: border-box;
              ">
            </div>
            <div style="display: flex; gap: 12px; margin-bottom: 16px;">
              <div style="flex: 1;">
                <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #c9d1d9;">–ù–∞—á–∞–ª–æ *</label>
                <input type="time" id="lessonStartTime" value="${currentTime}" required style="
                  width: 100%;
                  padding: 12px;
                  background: #21262d;
                  border: 1px solid #30363d;
                  border-radius: 8px;
                  color: white;
                  font-size: 14px;
                  box-sizing: border-box;
                ">
              </div>
              <div style="flex: 1;">
                <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #c9d1d9;">–û–∫–æ–Ω—á–∞–Ω–∏–µ *</label>
                <input type="time" id="lessonEndTime" required style="
                  width: 100%;
                  padding: 12px;
                  background: #21262d;
                  border: 1px solid #30363d;
                  border-radius: 8px;
                  color: white;
                  font-size: 14px;
                  box-sizing: border-box;
                ">
              </div>
            </div>
            <div style="margin-bottom: 16px;">
              <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #c9d1d9;">–ó–∞–º–µ—Ç–∫–∏</label>
              <textarea id="lessonNotes" rows="3" style="
                width: 100%;
                padding: 12px;
                background: #21262d;
                border: 1px solid #30363d;
                border-radius: 8px;
                color: white;
                font-size: 14px;
                box-sizing: border-box;
                resize: vertical;
                font-family: inherit;
              "></textarea>
            </div>
            <div style="display: flex; gap: 12px; margin-top: 20px;">
              <button type="button" onclick="closeAddLessonModal()" style="
                flex: 1;
                padding: 12px;
                background: #21262d;
                color: white;
                border: none;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
              ">–û—Ç–º–µ–Ω–∞</button>
              <button type="submit" style="
                flex: 1;
                padding: 12px;
                background: #1f6feb;
                color: white;
                border: none;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
              ">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
          </form>
        </div>
      `;
      
      document.body.appendChild(modal);
    }
    
    function closeAddLessonModal() {
      const modal = document.getElementById('addLessonModal');
      if (modal) {
        document.body.removeChild(modal);
      }
    }
    
    async function saveLesson(event) {
      event.preventDefault();
      
      const studentId = document.getElementById('lessonStudent').value;
      const subject = document.getElementById('lessonSubject').value;
      const lessonDate = document.getElementById('lessonDate').value;
      const startTime = document.getElementById('lessonStartTime').value;
      const endTime = document.getElementById('lessonEndTime').value;
      const notes = document.getElementById('lessonNotes').value.trim();
      
      if (!startTime || !endTime) {
        showNotice('–£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è', 'error');
        return;
      }
      
      if (startTime >= endTime) {
        showNotice('–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–∑–∂–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞', 'error');
        return;
      }
      
      try {
        const response = await fetch(`/api/lesson?tgId=${MY_ID}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            student_id: parseInt(studentId),
            subject: subject || null,
            lesson_date: lessonDate,
            start_time: startTime,
            end_time: endTime,
            notes: notes || null
          })
        });
        
        const result = await response.json();
        
        if (response.ok && result.ok) {
          showNotice('–ó–∞–Ω—è—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ', 'success');
          closeAddLessonModal();
          showLessons();
        } else {
          showNotice(result.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–Ω—è—Ç–∏—è', 'error');
        }
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–Ω—è—Ç–∏—è:', error);
        showNotice('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–Ω—è—Ç–∏—è', 'error');
      }
    }
    
    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–Ω—è—Ç–∏—è
    async function openEditLessonModal(lessonId) {
      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è
        const lessonsResponse = await fetch(`/api/teacher/lessons?tgId=${MY_ID}&t=${Date.now()}`);
        const lessonsData = await lessonsResponse.json();
        const lessons = lessonsData.lessons || [];
        const lesson = lessons.find(l => l.id === lessonId);
        
        if (!lesson) {
          showNotice('–ó–∞–Ω—è—Ç–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error');
          return;
        }
        
        const students = window.lessonsStudents || [];
        const subjects = window.lessonsSubjects || [];
        
        const modal = document.createElement('div');
        modal.id = 'editLessonModal';
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.8);
          z-index: 1000;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 20px;
        `;
        
        modal.innerHTML = `
          <div style="
            background: #161b22;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            border: 1px solid #30363d;
          ">
            <div style="font-size: 20px; font-weight: 600; margin-bottom: 16px; color: white;">
              –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–Ω—è—Ç–∏–µ
            </div>
            <form id="editLessonForm" onsubmit="updateLesson(event, ${lessonId})">
              <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #c9d1d9;">–£—á–µ–Ω–∏–∫ *</label>
                <select id="editLessonStudent" required style="
                  width: 100%;
                  padding: 12px;
                  background: #21262d;
                  border: 1px solid #30363d;
                  border-radius: 8px;
                  color: white;
                  font-size: 14px;
                  box-sizing: border-box;
                ">
                  <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞</option>
                  ${students.map(s => `
                    <option value="${s.id}" ${s.id === lesson.student_id ? 'selected' : ''}>${s.first_name} ${s.last_name || ''} ${s.class_name ? `(${s.class_name})` : ''}</option>
                  `).join('')}
                </select>
              </div>
              <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #c9d1d9;">–ü—Ä–µ–¥–º–µ—Ç</label>
                <select id="editLessonSubject" style="
                  width: 100%;
                  padding: 12px;
                  background: #21262d;
                  border: 1px solid #30363d;
                  border-radius: 8px;
                  color: white;
                  font-size: 14px;
                  box-sizing: border-box;
                ">
                  <option value="">–ù–µ —É–∫–∞–∑–∞–Ω</option>
                  ${subjects.map(s => `
                    <option value="${s}" ${s === lesson.subject ? 'selected' : ''}>${s}</option>
                  `).join('')}
                </select>
              </div>
              <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #c9d1d9;">–î–∞—Ç–∞ *</label>
                <input type="date" id="editLessonDate" value="${lesson.lesson_date}" required style="
                  width: 100%;
                  padding: 12px;
                  background: #21262d;
                  border: 1px solid #30363d;
                  border-radius: 8px;
                  color: white;
                  font-size: 14px;
                  box-sizing: border-box;
                ">
              </div>
              <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                <div style="flex: 1;">
                  <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #c9d1d9;">–ù–∞—á–∞–ª–æ *</label>
                  <input type="time" id="editLessonStartTime" value="${lesson.start_time}" required style="
                    width: 100%;
                    padding: 12px;
                    background: #21262d;
                    border: 1px solid #30363d;
                    border-radius: 8px;
                    color: white;
                    font-size: 14px;
                    box-sizing: border-box;
                  ">
                </div>
                <div style="flex: 1;">
                  <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #c9d1d9;">–û–∫–æ–Ω—á–∞–Ω–∏–µ *</label>
                  <input type="time" id="editLessonEndTime" value="${lesson.end_time}" required style="
                    width: 100%;
                    padding: 12px;
                    background: #21262d;
                    border: 1px solid #30363d;
                    border-radius: 8px;
                    color: white;
                    font-size: 14px;
                    box-sizing: border-box;
                  ">
                </div>
              </div>
              <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #c9d1d9;">–ó–∞–º–µ—Ç–∫–∏</label>
                <textarea id="editLessonNotes" rows="3" style="
                  width: 100%;
                  padding: 12px;
                  background: #21262d;
                  border: 1px solid #30363d;
                  border-radius: 8px;
                  color: white;
                  font-size: 14px;
                  box-sizing: border-box;
                  resize: vertical;
                  font-family: inherit;
                ">${lesson.notes || ''}</textarea>
              </div>
              <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button type="button" onclick="closeEditLessonModal()" style="
                  flex: 1;
                  padding: 12px;
                  background: #21262d;
                  color: white;
                  border: none;
                  border-radius: 8px;
                  font-size: 14px;
                  font-weight: 600;
                  cursor: pointer;
                ">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" style="
                  flex: 1;
                  padding: 12px;
                  background: #1f6feb;
                  color: white;
                  border: none;
                  border-radius: 8px;
                  font-size: 14px;
                  font-weight: 600;
                  cursor: pointer;
                ">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              </div>
            </form>
          </div>
        `;
        
        document.body.appendChild(modal);
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
        showNotice('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∑–∞–Ω—è—Ç–∏—è', 'error');
      }
    }
    
    function closeEditLessonModal() {
      const modal = document.getElementById('editLessonModal');
      if (modal) {
        document.body.removeChild(modal);
      }
    }
    
    async function updateLesson(event, lessonId) {
      event.preventDefault();
      
      const studentId = document.getElementById('editLessonStudent').value;
      const subject = document.getElementById('editLessonSubject').value;
      const lessonDate = document.getElementById('editLessonDate').value;
      const startTime = document.getElementById('editLessonStartTime').value;
      const endTime = document.getElementById('editLessonEndTime').value;
      const notes = document.getElementById('editLessonNotes').value.trim();
      
      if (!startTime || !endTime) {
        showNotice('–£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è', 'error');
        return;
      }
      
      if (startTime >= endTime) {
        showNotice('–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–∑–∂–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞', 'error');
        return;
      }
      
      try {
        const response = await fetch(`/api/lesson/${lessonId}?tgId=${MY_ID}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            student_id: parseInt(studentId),
            subject: subject || null,
            lesson_date: lessonDate,
            start_time: startTime,
            end_time: endTime,
            notes: notes || null
          })
        });
        
        const result = await response.json();
        
        if (response.ok && result.ok) {
          showNotice('–ó–∞–Ω—è—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
          closeEditLessonModal();
          showLessons();
        } else {
          showNotice(result.error || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–Ω—è—Ç–∏—è', 'error');
        }
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–Ω—è—Ç–∏—è:', error);
        showNotice('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–Ω—è—Ç–∏—è', 'error');
      }
    }
    
    async function deleteLesson(lessonId) {
      if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –∑–∞–Ω—è—Ç–∏–µ?')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/lesson/${lessonId}?tgId=${MY_ID}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (response.ok && result.ok) {
          showNotice('–ó–∞–Ω—è—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ', 'success');
          showLessons();
        } else {
          showNotice(result.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–Ω—è—Ç–∏—è', 'error');
        }
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–Ω—è—Ç–∏—è:', error);
        showNotice('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–Ω—è—Ç–∏—è', 'error');
      }
    }
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    window.showLessons = showLessons;
    window.openAddLessonModal = openAddLessonModal;
    window.closeAddLessonModal = closeAddLessonModal;
    window.saveLesson = saveLesson;
    window.openEditLessonModal = openEditLessonModal;
    window.closeEditLessonModal = closeEditLessonModal;
    window.updateLesson = updateLesson;
    window.deleteLesson = deleteLesson;
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function loadUser() {
      try {
        const response = await fetch(`/api/user?tgId=${MY_ID}&t=${Date.now()}`);
        const user = await response.json();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å - –µ—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ manager.html
        if (user.role === 'manager' || (user.role && user.role.toLowerCase().includes('manager'))) {
          console.log('‚ö†Ô∏è –ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–ø–∞–ª –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º...');
          window.location.href = `/manager.html?tgId=${MY_ID}`;
          return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å - –µ—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ manager.html
        if (user.role === 'manager' || (user.role && user.role.toLowerCase().includes('manager'))) {
          console.log('‚ö†Ô∏è –ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–ø–∞–ª –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º...');
          window.location.href = `/manager.html?tgId=${MY_ID}`;
          return;
        }
        
        document.getElementById('userName').textContent = user.name || "–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å";
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
        document.getElementById('userName').textContent = "–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å";
      }
    }
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
    function startAutoSync() {
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
      setInterval(async () => {
        if (!isSaving && document.visibilityState === 'visible') {
          console.log("üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π");
          await loadSchedule();
        }
      }, 60000);
      
      // –ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
          console.log("üì± –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–∫—Ç–∏–≤–Ω–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è");
          loadSchedule();
        }
      });
    }
    
    // ===== –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø =====
    
    async function init() {
      console.log("üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...");
      
      await loadUser();
      await loadSchedule(true); // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
      startAutoSync();
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
      setInterval(updateLastSyncTime, 60000);
      
      console.log("‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ");
    }
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–≥–¥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–ª–≥–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è –¥–ª—è –∑–∞–Ω—è—Ç—ã—Ö —è—á–µ–µ–∫
    let longPressTimer = null;
    let longPressTarget = null;
    let touchStartTime = null;
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–ª–≥–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è (–ø—Ä–∞–≤—ã–π –∫–ª–∏–∫ –∏–ª–∏ –¥–æ–ª–≥–æ–µ —É–¥–µ—Ä–∂–∞–Ω–∏–µ)
    function handleSlotLongPress(event, day, time, state) {
      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∑–∞–Ω—è—Ç—ã–µ —è—á–µ–π–∫–∏ (state === 2)
      if (state !== 2) {
        return;
      }
      
      event.preventDefault();
      event.stopPropagation();
      
      // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∏–º—è —É—á–µ–Ω–∏–∫–∞
      const currentValue = schedule[day]?.[time] || 0;
      const currentStudentName = typeof currentValue === 'object' && currentValue.student_name ? currentValue.student_name : '';
      
      // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
      const modal = document.createElement('div');
      modal.id = 'studentNameModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      `;
      
      modal.innerHTML = `
        <div style="
          background: #161b22;
          border-radius: 12px;
          padding: 24px;
          max-width: 350px;
          width: 100%;
          border: 1px solid #30363d;
        ">
          <div style="font-size: 20px; font-weight: 600; margin-bottom: 16px; color: white;">
            –ò–º—è —É—á–µ–Ω–∏–∫–∞
          </div>
          <div style="font-size: 14px; color: #8b949e; margin-bottom: 16px;">
            ${day}, ${time}
          </div>
          <input type="text" id="studentNameInput" value="${currentStudentName}" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è —É—á–µ–Ω–∏–∫–∞" style="
            width: 100%;
            padding: 12px;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            box-sizing: border-box;
            margin-bottom: 16px;
          " autofocus>
          <div style="display: flex; gap: 12px;">
            <button onclick="closeStudentNameModal()" style="
              flex: 1;
              padding: 12px;
              background: #21262d;
              color: white;
              border: none;
              border-radius: 8px;
              font-size: 14px;
              font-weight: 600;
              cursor: pointer;
            ">–û—Ç–º–µ–Ω–∞</button>
            <button onclick="saveStudentName('${day}', '${time}')" style="
              flex: 1;
              padding: 12px;
              background: #1f6feb;
              color: white;
              border: none;
              border-radius: 8px;
              font-size: 14px;
              font-weight: 600;
              cursor: pointer;
            ">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            ${currentStudentName ? `
            <button onclick="clearStudentName('${day}', '${time}')" style="
              padding: 12px;
              background: #da3633;
              color: white;
              border: none;
              border-radius: 8px;
              font-size: 14px;
              font-weight: 600;
              cursor: pointer;
            ">–û—á–∏—Å—Ç–∏—Ç—å</button>
            ` : ''}
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
      setTimeout(() => {
        const input = document.getElementById('studentNameInput');
        if (input) {
          input.focus();
          input.select();
        }
      }, 100);
      
      // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Enter
      const input = document.getElementById('studentNameInput');
      if (input) {
        input.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            saveStudentName(day, time);
          }
        });
      }
    }
    
    function closeStudentNameModal() {
      const modal = document.getElementById('studentNameModal');
      if (modal) {
        document.body.removeChild(modal);
      }
    }
    
    async function saveStudentName(day, time) {
      const input = document.getElementById('studentNameInput');
      if (!input) return;
      
      const studentName = input.value.trim();
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
      if (!schedule[day]) schedule[day] = {};
      const currentValue = schedule[day][time] || 0;
      const state = typeof currentValue === 'object' ? currentValue.status : currentValue;
      
      if (state === 2) {
        if (studentName) {
          schedule[day][time] = { status: 2, student_name: studentName };
        } else {
          schedule[day][time] = 2;
        }
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º UI
      const slotElement = document.getElementById(`slot-${day}-${time}`);
      if (slotElement && state === 2) {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –∏–º—è, –µ—Å–ª–∏ –µ—Å—Ç—å
        const nameDivs = slotElement.querySelectorAll('div');
        if (nameDivs.length > 2) {
          nameDivs[2].remove();
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –∏–º—è
        if (studentName) {
          const newNameDiv = document.createElement('div');
          newNameDiv.style.cssText = 'font-size: 9px; margin-top: 4px; opacity: 0.9; line-height: 1.2;';
          newNameDiv.textContent = studentName;
          slotElement.appendChild(newNameDiv);
        }
      }
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à
      saveToCache(schedule);
      lastScheduleHash = getScheduleHash(schedule);
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      try {
        const response = await fetch(`/api/schedule/${MY_ID}?tgId=${MY_ID}&t=${Date.now()}`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(schedule)
        });
        
        const result = await response.json();
        if (result.ok) {
          showNotice("–ò–º—è —É—á–µ–Ω–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ", "#238636", 1500);
          lastUpdateTime = result._timestamp || Date.now();
          updateLastSyncTime();
        }
      } catch (saveError) {
        console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä:", saveError);
        showNotice("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏", "#da3633", 2000);
      }
      
      closeStudentNameModal();
    }
    
    async function clearStudentName(day, time) {
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
      if (!schedule[day]) schedule[day] = {};
      const currentValue = schedule[day][time] || 0;
      const state = typeof currentValue === 'object' ? currentValue.status : currentValue;
      
      if (state === 2) {
        schedule[day][time] = 2;
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º UI
      const slotElement = document.getElementById(`slot-${day}-${time}`);
      if (slotElement && state === 2) {
        const nameDivs = slotElement.querySelectorAll('div');
        if (nameDivs.length > 2) {
          nameDivs[2].remove();
        }
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞–Ω—è—Ç–æ—Å—Ç–∏
      calculateOccupancy();
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à
      saveToCache(schedule);
      lastScheduleHash = getScheduleHash(schedule);
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      try {
        const response = await fetch(`/api/schedule/${MY_ID}?tgId=${MY_ID}&t=${Date.now()}`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(schedule)
        });
        
        const result = await response.json();
        if (result.ok) {
          showNotice("–ò–º—è —É—á–µ–Ω–∏–∫–∞ —É–¥–∞–ª–µ–Ω–æ", "#238636", 1500);
          lastUpdateTime = result._timestamp || Date.now();
          updateLastSyncTime();
        }
      } catch (saveError) {
        console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä:", saveError);
        showNotice("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏", "#da3633", 2000);
      }
      
      closeStudentNameModal();
    }
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
    window.forceRefresh = forceRefresh;
    window.showSchedule = showSchedule;
    window.showBookings = showBookings;
    window.showSubjects = showSubjects;
    window.toggleSlot = toggleSlot;
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ touch –¥–ª—è –¥–æ–ª–≥–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
    function handleSlotTouchStart(event, day, time, state) {
      if (state !== 2) {
        return;
      }
      
      touchStartTime = Date.now();
      longPressTarget = { day, time, state };
      
      longPressTimer = setTimeout(() => {
        if (longPressTarget && longPressTarget.day === day && longPressTarget.time === time) {
          // –°–æ–∑–¥–∞–µ–º —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
          const syntheticEvent = { preventDefault: () => {}, stopPropagation: () => {} };
          handleSlotLongPress(syntheticEvent, day, time, state);
          longPressTarget = null;
        }
      }, 500); // 500ms –¥–ª—è –¥–æ–ª–≥–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è
    }
    
    function handleSlotTouchEnd(event) {
      if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
      }
      
      // –ï—Å–ª–∏ –Ω–∞–∂–∞—Ç–∏–µ –±—ã–ª–æ –∫–æ—Ä–æ—Ç–∫–∏–º (–º–µ–Ω—å—à–µ 500ms), –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
      if (touchStartTime && Date.now() - touchStartTime < 500) {
        longPressTarget = null;
      }
      
      touchStartTime = null;
    }
    
    window.handleSlotLongPress = handleSlotLongPress;
    window.handleSlotTouchStart = handleSlotTouchStart;
    window.handleSlotTouchEnd = handleSlotTouchEnd;
    window.closeStudentNameModal = closeStudentNameModal;
    window.saveStudentName = saveStudentName;
    window.clearStudentName = clearStudentName;
    
    // –ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π –≤–∏–¥ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–º –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    function showCalendarView() {
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
      if (Object.keys(schedule).length === 0) {
        loadSchedule(true);
        setTimeout(() => openCalendarModal(), 500);
        return;
      }
      
      openCalendarModal();
    }
    
    function openCalendarModal() {
      const modal = document.createElement('div');
      modal.id = 'calendarModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #0d1117;
        z-index: 10000;
        overflow: auto;
        padding: 0;
      `;
      
      modal.innerHTML = renderCalendarView();
      document.body.appendChild(modal);
      
      // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
      document.body.style.overflow = 'hidden';
    }
    
    function closeCalendarModal() {
      const modal = document.getElementById('calendarModal');
      if (modal) {
        document.body.removeChild(modal);
        document.body.style.overflow = '';
      }
    }
    
    function renderCalendarView() {
      const FULL_DAYS = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];
      const DAYS_SHORT = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ª–æ—Ç—ã –ø–æ 30 –º–∏–Ω—É—Ç –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
      const TIMES = [];
      for (let h = 8; h <= 22; h++) {
        TIMES.push(`${h.toString().padStart(2, '0')}:00`);
        if (h < 22) TIMES.push(`${h.toString().padStart(2, '0')}:30`);
      }
      
      // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —è—á–µ–µ–∫
      const cellData = {};
      FULL_DAYS.forEach(day => {
        cellData[day] = {};
        TIMES.forEach((time, timeIndex) => {
          const slotValue = schedule[day]?.[time] || 0;
          const state = typeof slotValue === 'object' ? slotValue.status : slotValue;
          const studentName = typeof slotValue === 'object' && slotValue.student_name ? slotValue.student_name : null;
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –æ–±—ä–µ–¥–∏–Ω—è—Ç—å —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º —Å–ª–æ—Ç–æ–º
          let rowspan = 1;
          let shouldSkip = false;
          
          if (state === 2 && studentName && timeIndex > 0) {
            const prevTime = TIMES[timeIndex - 1];
            const prevSlotValue = schedule[day]?.[prevTime] || 0;
            const prevState = typeof prevSlotValue === 'object' ? prevSlotValue.status : prevSlotValue;
            const prevStudentName = typeof prevSlotValue === 'object' ? prevSlotValue.student_name : null;
            
            // –ï—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å–ª–æ—Ç —Ç–æ–∂–µ –∑–∞–Ω—è—Ç —Ç–µ–º –∂–µ —É—á–µ–Ω–∏–∫–æ–º, –æ–±—ä–µ–¥–∏–Ω—è–µ–º
            if (prevState === 2 && prevStudentName === studentName) {
              shouldSkip = true;
            }
          }
          
          if (!shouldSkip && state === 2 && studentName) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–∫–æ–ª—å–∫–æ —Å–ª–µ–¥—É—é—â–∏—Ö —Å–ª–æ—Ç–æ–≤ –∑–∞–Ω—è—Ç—ã —Ç–µ–º –∂–µ —É—á–µ–Ω–∏–∫–æ–º
            let nextIndex = timeIndex + 1;
            while (nextIndex < TIMES.length) {
              const nextTime = TIMES[nextIndex];
              const nextSlotValue = schedule[day]?.[nextTime] || 0;
              const nextState = typeof nextSlotValue === 'object' ? nextSlotValue.status : nextSlotValue;
              const nextStudentName = typeof nextSlotValue === 'object' ? nextSlotValue.student_name : null;
              
              if (nextState === 2 && nextStudentName === studentName) {
                rowspan++;
                nextIndex++;
              } else {
                break;
              }
            }
          }
          
          cellData[day][time] = {
            state,
            studentName,
            rowspan,
            shouldSkip
          };
        });
      });
      
      let html = `
        <div style="
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: #0d1117;
          padding: 8px;
          overflow: hidden;
          display: flex;
          flex-direction: column;
        ">
          <div style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 6px 10px;
            flex-shrink: 0;
          ">
            <h2 style="margin: 0; color: white; font-size: 16px; font-weight: 600;">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –Ω–µ–¥–µ–ª—é</h2>
            <button onclick="closeCalendarModal()" style="
              background: #da3633;
              color: white;
              border: none;
              padding: 5px 10px;
              border-radius: 6px;
              font-size: 11px;
              font-weight: 600;
              cursor: pointer;
              transition: background 0.2s;
            " onmouseover="this.style.background='#c62828'" onmouseout="this.style.background='#da3633'">
              ‚úï –ó–∞–∫—Ä—ã—Ç—å
            </button>
          </div>
          
          <div style="
            background: #161b22;
            border-radius: 8px;
            padding: 6px;
            overflow: hidden;
            flex: 1;
            display: flex;
            flex-direction: column;
          ">
            <div style="overflow: auto; flex: 1;">
              <table style="width: 100%; border-collapse: collapse; font-size: 9px; table-layout: fixed;">
                <thead>
                  <tr>
                    <th style="
                      background: #21262d;
                      color: #c9d1d9;
                      padding: 4px 3px;
                      text-align: center;
                      font-weight: 600;
                      border: 1px solid #30363d;
                      position: sticky;
                      left: 0;
                      z-index: 10;
                      width: 45px;
                      font-size: 8px;
                    ">–í—Ä–µ–º—è</th>
      `;
      
      // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ - –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ
      FULL_DAYS.forEach((day, index) => {
        html += `
          <th style="
            background: #21262d;
            color: #c9d1d9;
            padding: 4px 3px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #30363d;
            font-size: 9px;
          ">
            <div style="font-size: 10px; font-weight: 600;">${DAYS_SHORT[index]}</div>
          </th>
        `;
      });
      
      html += `</tr></thead><tbody>`;
      
      // –°—Ç—Ä–æ–∫–∏ —Å –≤—Ä–µ–º–µ–Ω–µ–º –∏ –¥–∞–Ω–Ω—ã–º–∏ - –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ–º
      TIMES.forEach((time, timeIndex) => {
        html += `<tr>`;
        
        // –Ø—á–µ–π–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ (sticky) - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–ª–æ—Ç–∞
        html += `
          <td style="
            background: #161b22;
            color: #8b949e;
            padding: 2px 1px;
            text-align: center;
            border: 1px solid #30363d;
            position: sticky;
            left: 0;
            z-index: 5;
            font-weight: 600;
            font-size: 8px;
            width: 45px;
            height: 18px;
          ">${time}</td>
        `;
        
        // –Ø—á–µ–π–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è - –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ–º
        FULL_DAYS.forEach(day => {
          const cell = cellData[day][time];
          
          // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —è—á–µ–π–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏
          if (cell.shouldSkip) {
            return;
          }
          
          let bgColor = '#21262d';
          let textColor = '#8b949e';
          
          if (cell.state === 1) {
            bgColor = '#238636';
            textColor = 'white';
          } else if (cell.state === 2) {
            bgColor = '#da3633';
            textColor = 'white';
          }
          
          const rowspanAttr = cell.rowspan > 1 ? `rowspan="${cell.rowspan}"` : '';
          const cellHeight = cell.rowspan > 1 ? cell.rowspan * 18 : 18;
          
          html += `
            <td ${rowspanAttr} style="
              background: ${bgColor};
              color: ${textColor};
              padding: 2px 1px;
              border: 1px solid #30363d;
              text-align: center;
              vertical-align: middle;
              height: ${cellHeight}px;
              font-size: 8px;
            ">
              ${cell.studentName ? `
                <div style="
                  font-size: 8px;
                  font-weight: 600;
                  padding: 1px 2px;
                  background: rgba(255, 255, 255, 0.2);
                  border-radius: 2px;
                  word-break: break-word;
                  line-height: 1.1;
                  overflow: hidden;
                  text-overflow: ellipsis;
                " title="${cell.studentName}">${cell.studentName.length > 10 ? cell.studentName.substring(0, 8) + '..' : cell.studentName}</div>
              ` : ''}
            </td>
          `;
        });
        
        html += `</tr>`;
      });
      
      html += `</tbody></table></div></div></div>`;
      
      return html;
    }
    
    window.showCalendarView = showCalendarView;
    window.closeCalendarModal = closeCalendarModal;
  </script>
</body>
</html>
